# War3 协议区别与 TCP/UDP 分布总结

## 1. 两套协议的核心区别

| 特性 | BNCS 协议 | W3GS 协议 |
| :--- | :--- | :--- |
| **全称** | **B**attle.**n**et **C**hat **S**ervice | **W**arcraft **III** **G**ame **S**ocket |
| **协议头** | **`0xFF`** | **`0xF7`** |
| **主要场景** | **大厅阶段**：登录、聊天、好友、房间列表 | **游戏阶段**：局域网广播、地图下载、游戏内指令同步 |
| **数据流向** | 客户端 <-> 战网服务器 | 客户端 <-> 主机 (Host) 或 局域网广播 |
| **主要传输层** | **纯 TCP** | **TCP 与 UDP 混用** |

---

## 2. 哪些包用 TCP？哪些包用 UDP？

### A. 必须使用 TCP 的场景 (可靠传输)
**特点**：数据绝对不能丢失，必须按顺序到达，通常数据量较大，会有分包 (粘包/半包) 现象。

#### 1. 所有 BNCS 协议包 (`0xFF`)
所有的战网管理操作都是 TCP。
*   **`0x09` SID_GETADVLISTEX**: 获取游戏房间列表（你遇到的 1460 字节截断问题源于此）。
*   **`0x0E` SID_ENTERCHAT**: 进入聊天频道。
*   **`0x50` SID_AUTH_INFO**: 登录验证信息。
*   **`0x1C` SID_LOGONRESPONSE**: 登录结果。

#### 2. 关键 W3GS 协议包 (`0xF7`)
涉及游戏核心逻辑同步的操作，为了防止掉线 (Desync)，必须走 TCP。
*   **游戏内指令**: 移动单位、训练单位、释放技能、使用物品。
*   **`0x17` W3GS_LEAVEGAME**: 离开游戏通知。
*   **`0x1B` W3GS_GAMELOADED**: 加载完成通知。
*   **`0x01` W3GS_PING_FROM_HOST**: 主机发来的 TCP 心跳/延迟检测。
*   **地图下载**: 进房后的地图传输数据流。

> **注意**：你在 IOCP (`GetQueuedCompletionStatus`) Hook 中捕获到的 `0xFF` 和 `0xF7` 包，**全部属于 TCP**。

---

### B. 使用 UDP 的场景 (无连接/广播)
**特点**：用于发现、广播或对实时性要求极高但允许丢包的场景。Hook IOCP 通常**抓不到**这些包（除非你 Hook 了 `recvfrom`）。

#### 1. 局域网发现与广播 (W3GS `0xF7`)
*   **`0x2F` W3GS_GAMEINFO**: 局域网主机广播“我就在这里，快来加入”。
*   **`0x30` W3GS_SEARCHGAME**: 客户端向局域网广播“有没有人在建主？”。
*   **`0x31` W3GS_GAMEINFO_V2**: 扩展的游戏信息广播。

#### 2. 连接握手与辅助
*   **`0x2F` (UDP版)**: 某些打洞 (NAT Punching) 操作。
*   **`0x05`**: 某些早期版本的端口检测。

---

## 3. 总结判定表

| 如果你看到... | 协议头 | 它是 TCP 还是 UDP? | 是否需要处理半包 (拼包)? |
| :--- | :--- | :--- | :--- |
| **大厅列表、聊天** | `0xFF` | **TCP** | **是** (必须处理) |
| **游戏内点击、指令** | `0xF7` | **TCP** | **是** (必须处理) |
| **局域网搜房间** | `0xF7` | **UDP** | 否 (通常一次收完) |
| **IOCP Hook 捕获的数据** | 任意 | **TCP** | **是** (物理特性决定) |